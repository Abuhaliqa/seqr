# Generated by Django 3.1.6 on 2021-04-20 15:30

from django.db import migrations, models
import logging
from seqr.utils.logging_utils import log_model_update, log_model_bulk_update

logger = logging.getLogger(__name__)


def merge_project_sanger_tags(apps, schema_editor):
    VariantTagType = apps.get_model("seqr", "VariantTagType")
    VariantTag = apps.get_model("seqr", "VariantTag")
    db_alias = schema_editor.connection.alias
    project_sanger_tag_types = VariantTagType.objects.using(db_alias).filter(name='Sanger in progress')
    if project_sanger_tag_types:
        logger.info('Merging "Sanger in progress" tags from {} projects'.format(len(project_sanger_tag_types)))
        main_tag_type = project_sanger_tag_types[0]
        main_tag_type.project=None
        main_tag_type.save()
        for sanger_tag_type in project_sanger_tag_types[1:]:
            tag_models = VariantTag.objects.using(db_alias).filter(variant_tag_type=sanger_tag_type)
            log_model_bulk_update(logger, tag_models, user=None, update_type='update', update_fields=['variant_tag_type'])
            tag_models.update(variant_tag_type=main_tag_type)
            log_model_update(logger, sanger_tag_type, user=None, update_type='delete')
            sanger_tag_type.delete()

def update_validation_tags(apps, schema_editor):
    # TODO for real
    Family = apps.get_model("seqr", "Family")
    db_alias = schema_editor.connection.alias
    Family.objects.using(db_alias).prefetch_related('individual_set').all()

class Migration(migrations.Migration):

    dependencies = [
        ('seqr', '0023_auto_20210304_2315'),
    ]

    operations = [
        migrations.AddField(
            model_name='varianttag',
            name='metadata',
            field=models.TextField(null=True),
        ),
        migrations.RunPython(merge_project_sanger_tags, reverse_code=migrations.RunPython.noop),
        # migrations.RunPython(update_validation_tags, reverse_code=migrations.RunPython.noop), # TODO reverse
    ]
