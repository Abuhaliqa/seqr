{% extends 'analysispage.html' %}
{% load x_extras %}
{% load static from staticfiles %}


{% block title %}<p><i>Matchbox</i>: The Broad Institute Matchmaker Exchange</p>{% endblock %}

{% block links %}
<script>
$(document).ready(
		function(){
			$('.afterSubmissionConfirmation').hide();
			$('.finalSubmissionData').hide();
			
			
			var base = window.location;
			var urlFields = new String(base).split("/");
			var projectId=urlFields[urlFields.length-3];
			var familyId=urlFields[urlFields.length-1];
			sessionStorage.projectId=projectId;
			sessionStorage.familyId=familyId;
			$('#projId').text(projectId);
			$('#familyId').text(familyId);
			//TODO: update title href as well
		});
</script>
Project: <a href=""><span id="projId"></span></a>
Family: <a href=""><span id="familyId"></span></a>
{% endblock %}
{% block innercontent %}
{% include 'javascript.html' %}
{% include 'family_warnings.html' %}
        
<div class="container">
	<div class="row">
		<div class="col-md-8">
				<h4 class="section-header">Alert</h4>
				<dl>You are about to submit patient information to the matchmaker exchange, the information submitted will be shared within this 
					<a href="http://www.matchmakerexchange.org/">matchmaker</a> network. The individual ID will be replaced by another unique value 
						    in order to obfuscate it. 
				</dl>	
				<br><br>
				<div class="col-md-2">
					<button type="button" class="btn btn-danger">Back</button>
				</div>
				<div class="col-md-2">
					<button type="button" class="btn btn-primary" id="continueWithsubmission">Continue</button>
				</div>
		</div>
	</div>
	<div class="row">		
		<div class="col-md-8 afterSubmissionConfirmation">
		<h4 class="section-header">Submission</h4>
  		<dl class="dl">
		<dd>The following phenotype and genotype information from all affected patient(s) will be submitted. 
		    When allowed, please select any information that you do not wish to submit, 
		    while keeping in mind that the strength of a match might be dependent 
		    how much information you provide.
		</dd>
		<br><br>
			
		<!-- 			
		<h5 class="section-header">General</h5>
		<div class="col-md-8">
		<table id="generalSubmissionCandidateInfoTbl" class="table table-hover">
			<thead>
				<tr>
					<td>Individual Id</td>
					<td>Sex</td>
					<td>Species</td>
					<td>Contact name</td>
					<td>Contact URL</td>
					<td>Contact Institution</td>
				</tr>
			</thead>
			<tbody></tbody>
			</table>
		</div>
		-->					
		<h5 class="section-header">Phenotype</h5>
		<table id="phenotypeSubmissionCandidateInfoTbl" class="table table-hover">
			<thead>
				<tr>
					<td>Individual Id</td>
					<td>HPO Terms</td>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
						
		<h5 class="section-header">Genotype</h5>
		<table id="genotypeSubmissionCandidateInfoTbl" class="table table-hover">
			<thead>
				<tr>
					<td>Individual Id</td>
					<td>Genotype</td>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
					
		</div>
 	</div>
 	
 	<div class="row afterSubmissionConfirmation"> 		
 		<h4>Once you have de-selected any genotypes that you do not wish to submit,</h4> 
 		<button type="button" class="btn btn-primary" id="finalSelectionConfirmed">Continue</button>
	    
	    
	    <div id="finalSelectionTblContainer finalSubmissionData">
	    <h4 class="section-header finalSubmissionData">Final submission</h4>
	    <div id="finalSelectionTbl"></div>
		<div id="finalSelectionTbl finalSubmissionData"></div>
			<button type="button" id="d" class="btn btn-primary submitPatient finalSubmissionData" value="hh">Submit individual</button>
		</div>
	</div>
</div>			

    
<script>

/**
 * Given a patient ID (NAxxx,) export all data about it to matchmaker exchange for sharing
 **/
function startExportProcess() {
	 var url = "/api/matchmaker/candidate/project/" + sessionStorage.projectId +"/family/" + sessionStorage.familyId;
	 $.ajax({url: url, 
		 	success: function(result){
	            showMMECandidates(result);
		 	},
		    async:false,  
	 });
}

/**
 * Show submission candidates and get approval
 */
function showMMECandidates(result){
	var patients=[];
	for (var i=0; i<result['submission_candidates'].length;i++){
		var patient=result['submission_candidates'][i]['patient'];
		var idMap = result['id_maps'][i];
		patients.push({'local_id':idMap['individual_id'], 'patient':patient});
		/**
		//General info
		var html='<tr>';
		html += '<td><p data-toggle="tooltip" data-placement="top" title="Obfuscated id: ' + patient['label'] + '">' + idMap['individual_id'] + '</p></td>';
		html += '<td><p>' +patient['sex'] + '</p></td>';
		html += '<td><p>' +patient['species'] + '</p></td>';
		html += '<td><p>' +patient['contact']['name'] + '</p></td>';
		html += '<td><p>' +patient['contact']['href'] + '</p></td>';
		html += '<td><p>' +patient['contact']['institution'] + '</p></td>';
		html += '</tr>'
		$('#generalSubmissionCandidateInfoTbl tbody').append(html);
		**/
		//Phenotype info
		html='<tr>';
		html += '<td><p>' + idMap['individual_id'] + '</p></td>';
		html += '<td><p><table class="table table-hover"><thead><td></td><td></td></thead><tbody>';
		for (var j=0; j<patient['features'].length;j++){
			html += '<tr><td><p>' + patient['features'][j]['id'] + '</p></td><td><p>' + patient['features'][j]['observed']+  '</p></td></tr>';	
		}
		html += '</tbody></p></td>';
		html += '</tr>';
		$('#phenotypeSubmissionCandidateInfoTbl tbody').append(html);

		//Genotype info
		html='<tr>';
		html += '<td><p>' + idMap['individual_id'] + '</p></td>';
		html += '<td><p>';
		//sub table inside cell for list of variants
		html += '<table class="table table-hover">';
		html += '<thead><tr>';
		html += '<td>Gene Id</td>';
		html += '<td>Reference name</td>';
		html += '<td>Assembly</td>';
		html += '<td>Variant-start</td>';
		html += '<td>Variant-end</td>';
		html += '<td>Reference bases</td>';
		html += '<td>Alternate bases</td>';
		html += '<td>Submit</td>';
		html += '</tr></thead><tbody>'
		for (var k=0; k<patient['genomicFeatures'].length;k++){
			html += '<tr>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['gene']['id']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['referenceName']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['assembly']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['start']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['end']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['referenceBases']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['alternateBases']   + '</p></td>';
			html += '<td><p>'  +  '<input id="'+ idMap['individual_id'] + '" class="deselected_genomic_features" checked type="checkbox" value="'+ k + '"></p></td>';
			html += '</tr>';
		}
		//close sub table
		html += '</tbody></table>';
		
		//close main table
		html += '</p></td>';
		html += '</tr>';
		$('#genotypeSubmissionCandidateInfoTbl tbody').append(html);
		$(function () {
			  $('[data-toggle="tooltip"]').tooltip();
			});
	}
	sessionStorage.patients=JSON.stringify(patients);
	return true;
}


/**
 * Shows the final patient structure that is about to be submitted
 */
function showFinalSelection(){
	//find indexes of deselected genotypes, index denotes genotype index
	//and 1 denotes "ignore" and 0 denotes "use"
	var ignoreThisGenotype=[];
	var index=0;
	$( ".deselected_genomic_features" ).each(function(i) {
		ignoreThisGenotype.push(0);
		if ($(this).is(':checked')){
			ignoreThisGenotype[index]=1;
		}
		index+=1;
		});
	var html='<table id="finalSelectionTbl" class="table table-hover">';
	html += '<thead><tr>';
	html += '<td><p>' + 'Field' + '</p></td>';
	html += '<td><p>' + 'Value' + '</p></td>';
	html += '</tr></thead><tbody>';
	var asJson=JSON.parse(sessionStorage.patients);
	for (var i=0; i<asJson.length;i++){
		var patient = asJson[i]['patient'];
		var individualId =asJson[i]['local_id'];
		$('#finalSelectionTblContainer').append('<br><h4>Information finalized for individual: '+ individualId+'</h5>');
		//General
		html += '<tr><td><p>Obfuscated Id</p></td>' + '<td><p>' +patient['id'] + '</p></td></tr>';
		html += '<tr><td><p>sex' + '<td><p>' +patient['sex'] + '</p></td></tr>';
		html += '<tr><td><p>label</p></td>' + '<td><p>' +patient['label'] + '</p></td></tr>';
		html += '<tr><td><p>species</p></td>' + '<td><p>' +patient['species'] + '</p></td></tr>';
		html += '<tr><td><p>Contact name</p></td>' + '<td><p>' +patient['contact']['name'] + '</p></td></tr>';
		html += '<tr><td><p>Contact URL</p></td>' + '<td><p>' +patient['contact']['href'] + '</p></td></tr>';
		html += '<tr><td><p>Contact institution</p></td>' + '<td><p>' +patient['contact']['institution'] + '</p></td></tr>';
		//Phenotypes
		html += '<tr><td><p>Phenotypes</p></td><td><table class="table table-hover"><thead><td></td><td></td></thead><tbody>'; 
		for (var j=0; j<patient['features'].length;j++){
			html += '<tr><td>' + patient['features'][j]['id'] + '</td><td>' + patient['features'][j]['observed'] + '</td><tr>';
		}
		html += '</tbody></table></td></tr>';
		//Genotypes sub table
		html += '<tr>';
		html += '<td><p>Genotypes</p></td><td>';
		html += '<table class="table table-hover">';
		html += '<thead><tr>';
		html += '<td>Gene Id</td>';
		html += '<td>Reference name</td>';
		html += '<td>Assembly</td>';
		html += '<td>Variant-start</td>';
		html += '<td>Variant-end</td>';
		html += '<td>Reference bases</td>';
		html += '<td>Alternate bases</td>';
		html += '</tr></thead><tbody>'
		for (var k=0; k<patient['genomicFeatures'].length;k++){
			html += '<tr>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['gene']['id']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['referenceName']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['assembly']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['start']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['end']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['referenceBases']   + '</p></td>';
			html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['alternateBases']   + '</p></td>';
			html += '</tr>';
		}
		//close sub table
		html += '</tbody></table></td></tr>';
		
		//submit this patient
		//html += '<tr><td></td>';
		//html += '<td>';
		//html += '</td></tr>';
		
		//close main table
		html += '</tbody></table>'
	}
	$('#finalSelectionTbl').append(html);
	$('.finalSubmissionData').show();
}

</script>
    
<script>
/**
* Click handlers
*/ 

/**
 * When the user decides to continue with submission
 */
$('#continueWithsubmission').click(
	function start(){
		$('.afterSubmissionConfirmation').show();
		startExportProcess();
	});
	
/**
 * When the user deslects any genotypes they don't want to submit and hits continue
 */
$('#finalSelectionConfirmed').click(
		function start(){
			showFinalSelection();
		});
		
/**
 * When the user hits submit
 */
$('#d').click(
		function s(){
			alert('dd');
			//console.log($(this).val());
		});

</script>

{% endblock %}


